/**
 * Copyright 2014 IBM Corp.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Angular module for Rtcomm
 * @version v1.0.3 - 2016-02-18
 * @link https://github.com/WASdev/lib.angular-rtcomm
 * @author Brian Pulito <brian_pulito@us.ibm.com> (https://github.com/bpulito)
 */
!function(){angular.module("angular-rtcomm",["ui.bootstrap","treeControl","angular-rtcomm-ui","angular-rtcomm-presence","angular-rtcomm-service"])}(),function(){function a(a,b,c){b.debug("RtcommConfigService: Abs URL: "+a.absUrl());var d=a.search().disableRtcomm;d="undefined"==typeof d||null===d?!1:"true"===d?!0:!1,b.debug("RtcommConfigService: _disableRtcomm = "+d);var e={server:a.host(),port:a.port(),rtcommTopicPath:"/rtcomm/",createEndpoint:!1,appContext:"default",userid:"",presence:{topic:""}};b.debug("providerConfig.server: "+e.server),b.debug("providerConfig.port: "+e.port);var f={chat:!0,webrtc:!0},g=!0,h=!0,i="DEBUG",j=null,k=null,l=!0,m=function(a){e.server="undefined"!=typeof a.server?a.server:e.server,e.port="undefined"!=typeof a.port?a.port:e.port,e.rtcommTopicPath="undefined"!=typeof a.rtcommTopicPath?a.rtcommTopicPath:e.rtcommTopicPath,e.createEndpoint="undefined"!=typeof a.createEndpoint?a.createEndpoint:e.createEndpoint,e.appContext="undefined"!=typeof a.appContext?a.appContext:e.appContext,e.presence.topic="undefined"!=typeof a.presenceTopic?a.presenceTopic:e.presence.topic,f.chat="undefined"!=typeof a.chat?a.chat:f.chat,f.webrtc="undefined"!=typeof a.webrtc?a.webrtc:f.webrtc,g="undefined"!=typeof a.broadcastAudio?a.broadcastAudio:g,h="undefined"!=typeof a.broadcastVideo?a.broadcastVideo:h,l="undefined"!=typeof a.trickleICE?a.trickleICE:l,k="undefined"!=typeof a.ringbacktone?a.ringbacktone:k,j="undefined"!=typeof a.ringtone?a.ringtone:j,i="undefined"!=typeof a.rtcommDebug?a.rtcommDebug:i,b.debug("rtcommDebug from config is: "+a.rtcommDebug),"undefined"!=typeof a.userid&&(e.userid=a.userid),b.debug("providerConfig is now: ",e)};return{setProviderConfig:function(a){m(a)},getProviderConfig:function(){return e},getWebRTCEnabled:function(){return f.webrtc},getChatEnabled:function(){return f.chat},getBroadcastAudio:function(){return g},getBroadcastVideo:function(){return h},getRingTone:function(){return j},getRingBackTone:function(){return k},getRtcommDebug:function(){return i},isRtcommDisabled:function(){return d},getTrickleICE:function(){return l}}}function b(a,b,c,d){var e=new rtcomm.EndpointProvider,f=!1,g=null,h=[],i=null,j=!1,k="selfView",l="remoteView";e.setLogLevel(d.getRtcommDebug()),b.debug("rtcomm-service - endpointProvider log level is: "+e.getLogLevel()),b.debug("rtcomm-service - endpointProvider log level should be: "+d.getRtcommDebug()),e.setAppContext(d.getProviderConfig().appContext);var m=function(){return null==i&&(i={state:"available",userDefines:[]}),i},n=function(){var a={ringbacktone:d.getRingBackTone(),ringtone:d.getRingTone(),webrtcConfig:{broadcast:{audio:d.getBroadcastAudio(),video:d.getBroadcastVideo()},trickleICE:d.getTrickleICE()},webrtc:d.getWebRTCEnabled(),chat:d.getChatEnabled()};return a};e.on("reset",function(a){f=!1,x({type:"danger",msg:a.reason})}),e.on("queueupdate",function(c){b.debug("<<------rtcomm-service------>> - Event: queueupdate"),b.debug("queueupdate",c),a.$evalAsync(function(){a.$broadcast("queueupdate",c)})}),e.on("newendpoint",function(c){b.debug("<<------rtcomm-service------>> - Event: newendpoint remoteEndpointID: "+c.getRemoteEndpointID()),c.on("onetimemessage",function(c){if(b.debug("<<------rtcomm-onetimemessage------>> - Event: ",c),"undefined"!=c.onetimemessage.type&&"iFrameURL"==c.onetimemessage.type){var d=s(c.endpoint.id);d.iFrameURL=c.onetimemessage.iFrameURL,a.$evalAsync(function(){a.$broadcast("rtcomm::iframeUpdate",c.endpoint.id,c.onetimemessage.iFrameURL)})}}),a.$evalAsync(function(){a.$broadcast("newendpoint",c)})});var o=function(c){b.debug("<<------rtcomm-service------>> - Event: "+c.eventName+" remoteEndpointID: "+c.endpoint.getRemoteEndpointID()),a.$evalAsync(function(){if(c.eventName.indexOf("session:")>-1){var b=s(c.endpoint.id);b.sessionState=c.eventName}a.$broadcast(c.eventName,c)}),1==j&&a.$digest()};e.setRtcommEndpointConfig({ringtone:d.getRingTone(),ringbacktone:d.getRingBackTone(),"session:started":function(c){b.debug("<<------rtcomm-service------>> - Event: "+c.eventName+" remoteEndpointID: "+c.endpoint.getRemoteEndpointID()),a.$evalAsync(function(){var b=s(c.endpoint.id);v(c.endpoint.id),b.sessionStarted=!0,b.remoteEndpointID=c.endpoint.getRemoteEndpointID(),a.$broadcast(c.eventName,c)}),1==j&&a.$digest()},"session:alerting":o,"session:trying":o,"session:ringing":o,"session:queued":o,"session:failed":function(c){b.debug("<<------rtcomm-service------>> - Event: "+c.eventName+" remoteEndpointID: "+c.endpoint.getRemoteEndpointID()),a.$evalAsync(function(){t(c.endpoint.id),a.$broadcast(c.eventName,c)}),1==j&&a.$digest()},"session:stopped":function(c){b.debug("<<------rtcomm-service------>> - Event: "+c.eventName+" remoteEndpointID: "+c.endpoint.getRemoteEndpointID()),a.$evalAsync(function(){t(c.endpoint.id),a.$broadcast(c.eventName,c)}),1==j&&a.$digest()},"session:connecting":o,"webrtc:connected":function(c){b.debug("<<------rtcomm-service------>> - Event: "+c.eventName+" remoteEndpointID: "+c.endpoint.getRemoteEndpointID()),a.$evalAsync(function(){s(c.endpoint.id).webrtcConnected=!0,a.$broadcast(c.eventName,c)}),1==j&&a.$digest()},"webrtc:remotemuted":function(c){b.debug("<<------rtcomm-service------>> - Event: "+c.eventName+" remoteEndpointID: "+c.endpoint.getRemoteEndpointID()),a.$evalAsync(function(){a.$broadcast(c.eventName,c)}),1==j&&a.$digest()},"webrtc:disconnected":function(c){b.debug("<<------rtcomm-service------>> - Event: "+c.eventName+" remoteEndpointID: "+c.endpoint.getRemoteEndpointID()),a.$evalAsync(function(){var b=r(c.endpoint.id);null!=b&&(b.webrtcConnected=!1),a.$broadcast(c.eventName,c)}),1==j&&a.$digest()},"chat:connected":o,"chat:disconnected":o,"chat:message":function(c){b.debug("<<------rtcomm-service------>> - Event: "+c.eventName+" remoteEndpointID: "+c.endpoint.getRemoteEndpointID()),a.$evalAsync(function(){var b={time:new Date,name:c.message.from,message:angular.copy(c.message.message)};s(c.endpoint.id).chats.push(b),a.$broadcast(c.eventName,c)}),1==j&&a.$digest()},destroyed:o});var p=function(c){b.debug("<<------rtcomm-service------>> - Event: Provider init succeeded"),null!=i&&(b.debug("RtcommService: initSuccess: updating presence record"),e.publishPresence(i)),a.$evalAsync(function(){var b={ready:c.ready,registered:c.registered,endpoint:c.endpoint,userid:d.getProviderConfig().userid};a.$broadcast("rtcomm::init",!0,b)}),1==j&&a.$digest()},q=function(c){b.debug("<<------rtcomm-service------>> - Event: Provider init failed: error: ",c),a.$evalAsync(function(){a.$broadcast("rtcomm::init",!1,c)}),1==j&&a.$digest()},r=function(a){for(var b=null,c=0;c<h.length;c++)if(h[c].endpointUUID===a){b=h[c];break}return b},s=function(a){for(var b=null,c=0;c<h.length;c++)if(h[c].endpointUUID===a){b=h[c];break}return null==b&&(b={endpointUUID:a,chats:[],webrtcConnected:!1,sessionStarted:!1,iFrameURL:"about:blank",remoteEndpointID:null,activated:!0,sessionState:"session:stopped"},h[h.length]=b),b},t=function(b){for(var c=0;c<h.length;c++)if(h[c].endpointUUID===b){var d=u(b);"undefined"!=typeof d&&d.destroy(),h.splice(c,1),0==h.length?a.$broadcast("noEndpointActivated"):v(h[0].endpointUUID);break}},u=function(c){var d=null;return"undefined"==typeof c||null==c?(b.debug("getEndpoint: create new endpoint and setup onetimemessage event"),d=e.createRtcommEndpoint(),d.on("onetimemessage",function(c){if(b.debug("<<------rtcomm-onetimemessage------>> - Event: ",c),"undefined"!=c.onetimemessage.type&&"iFrameURL"==c.onetimemessage.type){var d=s(c.endpoint.id);d.iFrameURL=c.onetimemessage.iFrameURL,a.$evalAsync(function(){a.$broadcast("rtcomm::iframeUpdate",c.endpoint.id,c.onetimemessage.iFrameURL)})}})):d=e.getRtcommEndpoint(c),d},v=function(b){var c=w();if(null!=c&&c!=b){var d=r(c);null!=d&&(d.activated=!1)}var d=s(b);d.activated=!0,a.$broadcast("endpointActivated",b)},w=function(){for(var a=null,b=0;b<h.length;b++)if(1==h[b].activated){a=h[b].endpointUUID;break}return a},x=function(b){var c={type:"info",msg:"default message"};"string"==typeof b?c.msg=b:c=b,a.$evalAsync(function(){a.$broadcast("rtcomm::alert",c)})};return{alert:x,setKarmaTesting:function(){j=!0},isInitialized:function(){return f},setConfig:function(a){return 1==d.isRtcommDisabled()?void b.debug("RtcommService:setConfig: isRtcommDisabled = true; return with no setup"):(b.debug("rtcomm-services: setConfig: config: ",a),d.setProviderConfig(a),e.setRtcommEndpointConfig(n()),void(0==f&&("undefined"!=typeof a.identityServlet&&null!=a.identityServlet?c.get(a.identityServlet).success(function(a){"undefined"!=typeof a.userid?(d.setProviderConfig(a),e.init(d.getProviderConfig(),p,q),f=!0):b.error("RtcommService: setConfig promise: Invalid JSON object return from identityServlet: ",a)}).error(function(a,c,d,e){b.debug("RtcommService: setConfig promise: error accessing userid from identityServlet: "+c)}):("undefined"==typeof a.userid||""!=d.getProviderConfig().userid)&&(e.init(d.getProviderConfig(),p,q),f=!0))))},getPresenceMonitor:function(a){return e.getPresenceMonitor(a)},publishPresence:function(){1==f&&e.publishPresence(m())},addToPresenceRecord:function(a){for(var c=0;c<a.length;c++)m().userDefines.push(a[c]);1==f&&(b.debug("RtcommService: addToPresenceRecord: updating presence record to: ",m()),e.publishPresence(m()))},removeFromPresenceRecord:function(a,c){for(var d=0;d<a.length;d++)for(var g=0;g<m().userDefines.length;g++)if(m().userDefines[g].name==a[d].name){m().userDefines.splice(g,1);break}1==f&&c&&(b.debug("RtcommService: removeFromPresenceRecord: updating presence record to: ",m()),e.publishPresence(m()))},setPresenceRecordState:function(a){return m().state=a,e.publishPresence(m())},getEndpoint:function(a){return u(a)},destroyEndpoint:function(a){e.getRtcommEndpoint(a).destroy()},register:function(a){0==f?(d.getProviderConfig().userid=a,e.init(d.getProviderConfig(),p,q),f=!0):b.error("rtcomm-services: register: ERROR: endpoint provider already initialized")},unregister:function(){1==f?(e.destroy(),f=!1,q("destroyed")):b.error("rtcomm-services: unregister: ERROR: endpoint provider not initialized")},joinQueue:function(a){e.joinQueue(a)},leaveQueue:function(a){e.leaveQueue(a)},getQueues:function(){return g},sendChatMessage:function(a,b){var c=s(b);c.chats.push(a),e.getRtcommEndpoint(b).chat.send(a.message)},getChats:function(a){if("undefined"!=typeof a&&null!=a){var b=r(a);return null!=b?b.chats:null}return null},isWebrtcConnected:function(a){if("undefined"!=typeof a&&null!=a){var b=r(a);return null!=b?b.webrtcConnected:!1}return!1},getSessionState:function(a){return"undefined"!=typeof a&&null!=a?e.getRtcommEndpoint(a).getState():"session:stopped"},setAlias:function(a){"undefined"!=typeof a&&""!=a&&e.setUserID(a)},setUserID:function(a){"undefined"!=typeof a&&""!=a&&(d.setProviderConfig({userid:a}),e.init(d.getProviderConfig(),p,q))},setPresenceTopic:function(a){"undefined"!=typeof a&&""!=a&&(d.setProviderConfig({presenceTopic:a}),e.init(d.getProviderConfig(),p,q))},getIframeURL:function(a){if("undefined"!=typeof a&&null!=a){var b=r(a);return null!=b?b.iFrameURL:null}return null},putIframeURL:function(a,c){b.debug("RtcommService: putIframeURL: endpointUUID: "+a+" newURL: "+c);var d=e.getRtcommEndpoint(a);if(null!=d){var f=s(a);f.iFrameURL=c;var g={type:"iFrameURL",iFrameURL:c};b.debug("RtcommService: putIframeURL: sending new iFrame URL"),d.sendOneTimeMessage(g)}},placeCall:function(a,b){var c=u();if(b.indexOf("chat")>-1&&c.chat.enable(),b.indexOf("webrtc")>-1){var d=!0;b.indexOf("disableTrickleICE")>-1&&(d=!1),c.webrtc.enable({trickleICE:d})}return v(c.id),c.connect(a),c.id},getSessions:function(){return h},endCall:function(a){a.disconnect()},setActiveEndpoint:function(a){v(a)},getActiveEndpoint:function(){return w()},getRemoteEndpoint:function(a){var b=null;if(null!=a){var c=r(a);null!=c&&(b=c.remoteEndpointID)}return b},setDefaultViewSelector:function(){k="selfView",l="remoteView"},setViewSelector:function(a,b){k=a,l=b},setVideoView:function(a){b.debug("rtcommVideo: setting local media");var c=null;"undefined"!=typeof a&&null!=a?c=u(a):null!=w()&&(c=u(w())),null!=c&&c.webrtc.setLocalMedia({mediaOut:document.querySelector("#"+k),mediaIn:document.querySelector("#"+l)})}}}angular.module("angular-rtcomm-service",[]).config(["$logProvider",function(a){a.debugEnabled(!0)}]).factory("RtcommConfigService",a).factory("RtcommService",b),a.$inject=["$location","$log","$window"],b.$inject=["$rootScope","$log","$http","RtcommConfigService"]}(),function(){function a(a,b){return{restrict:"E",templateUrl:"templates/rtcomm/rtcomm-sessionmgr.html",controller:["$scope",function(c){c.sessions=a.getSessions(),c.sessMgrActiveEndpointUUID=a.getActiveEndpoint(),c.publishPresence=!1,c.sessionPresenceData=[],c.init=function(a){c.publishPresence=a,c.updatePresence()},c.$on("endpointActivated",function(a,d){b.debug("rtcommSessionmgr: endpointActivated ="+d),c.sessMgrActiveEndpointUUID=d}),c.$on("session:started",function(a,d){b.debug("rtcommSessionmgr: session:started: uuid ="+d.endpoint.id),c.updatePresence()}),c.activateSession=function(d){b.debug("rtcommSessionmgr: activateEndpoint ="+d),c.sessMgrActiveEndpointUUID!=d&&a.setActiveEndpoint(d)},c.updatePresence=function(){1==c.publishPresence&&(a.removeFromPresenceRecord(c.sessionPresenceData,!1),c.sessionPresenceData=[{name:"sessions",value:String(c.sessions.length)}],a.addToPresenceRecord(c.sessionPresenceData))}}],controllerAs:"sessionmgr"}}function b(a,b){return{restrict:"E",templateUrl:"templates/rtcomm/rtcomm-register.html",controller:["$scope",function(c){c.nextAction="Register",c.reguserid="",c.invalid=!1;var d=/(\$|#|\+|\/|\\)+/i;c.$watch("reguserid",function(){c.reguserid.length<1||d.test(c.reguserid)?c.invalid=!0:c.invalid=!1}),c.onRegClick=function(){"Register"!==c.nextAction||d.test(c.reguserid)?(b.debug("Unregister: reguserid ="+c.reguserid),a.unregister()):(b.debug("Register: reguserid ="+c.reguserid),a.register(c.reguserid))},c.$on("rtcomm::init",function(a,b,d){1==b?(c.nextAction="Unregister",c.reguserid=d.userid):(c.nextAction="Register","destroyed"==d?c.reguserid="":c.reguserid="Init failed:"+d)})}],controllerAs:"register"}}function c(a,b){return{restrict:"E",templateUrl:"templates/rtcomm/rtcomm-queues.html",controller:["$scope",function(c){c.rQueues=[],c.autoJoinQueues=!1,c.queuePresenceData=[],c.queuePublishPresence=!1,c.queueFilter=null,c.init=function(a,d,e){b.debug("rtcommQueues: autoJoinQueues = "+a),c.autoJoinQueues=a,c.queuePublishPresence=d,"undefined"!=typeof e&&(c.queueFilter=e)},c.$on("queueupdate",function(a,d){b.debug("rtcommQueues: scope queues",c.rQueues),Object.keys(d).forEach(function(a){b.debug("rtcommQueues: Push queue: "+d[a]),b.debug("rtcommQueues: autoJoinQueues: "+c.autoJoinQueues),0==c.filterOutQueue(d[a])&&(c.rQueues.push(d[a]),1==c.autoJoinQueues&&c.onQueueClick(d[a]))}),c.updateQueuePresence()}),c.$on("rtcomm::init",function(a,d,e){0==d&&(b.debug("rtcommQueues: init: clear queues"),c.rQueues=[])}),c.filterOutQueue=function(a){var b=!0;if(null!=c.queueFilter)for(var d=0;d<c.queueFilter.length;++d){var e=c.queueFilter[d];if(e==a.endpointID){b=!1;break}}else b=!1;return b},c.onQueueClick=function(d){b.debug("rtcommQueues: onClick: TOP");for(var e=0;e<c.rQueues.length;e++)c.rQueues[e].endpointID===d.endpointID?(b.debug("rtcommQueues: onClick: queue.endpointID = "+d.endpointID),0==d.active?(a.joinQueue(d.endpointID),c.rQueues[e].active=!0):(a.leaveQueue(d.endpointID),c.rQueues[e].active=!1)):e==c.rQueues.length-1&&b.debug("rtcommQueues: ERROR: queue.endpointID: "+d.endpointID+" not found in list of queues");c.updateQueuePresence()},c.updateQueuePresence=function(){if(1==c.queuePublishPresence){a.removeFromPresenceRecord(c.queuePresenceData,!1),c.queuePresenceData=[];for(var b=0;b<c.rQueues.length;b++)c.rQueues[b].active===!0&&c.queuePresenceData.push({name:"queue",value:c.rQueues[b].endpointID});a.addToPresenceRecord(c.queuePresenceData)}}}],controllerAs:"queues"}}function d(a){return{restrict:"E",templateUrl:"templates/rtcomm/rtcomm-alert.html",controller:["$scope",function(a){a.alerts=[],a.addAlert=function(b){a.alerts.push(b)},a.closeAlert=function(b){a.alerts.splice(b,1)},a.$on("rtcomm::alert",function(b,c){a.addAlert(c)})}]}}function e(a,b){return{restrict:"E",templateUrl:"templates/rtcomm/rtcomm-endpoint-status.html",controller:["$scope",function(c){c.epCtrlActiveEndpointUUID=a.getActiveEndpoint(),c.epCtrlRemoteEndpointID=a.getRemoteEndpoint(c.epCtrlActiveEndpointUUID),c.sessionState=a.getSessionState(c.epCtrlActiveEndpointUUID),c.failureReason="",c.queueCount=0,c.$on("session:started",function(a,d){b.debug("session:started received: endpointID = "+d.endpoint.id),c.epCtrlActiveEndpointUUID==d.endpoint.id&&(c.sessionState="session:started",c.epCtrlRemoteEndpointID=d.endpoint.getRemoteEndpointID())}),c.$on("session:stopped",function(a,d){b.debug("session:stopped received: endpointID = "+d.endpoint.id),c.epCtrlActiveEndpointUUID==d.endpoint.id&&(c.sessionState="session:stopped",c.epCtrlRemoteEndpointID=null)}),c.$on("session:failed",function(a,d){b.debug("session:failed received: endpointID = "+d.endpoint.id),c.epCtrlActiveEndpointUUID==d.endpoint.id&&(c.sessionState="session:failed",c.failureReason=d.reason,c.epCtrlRemoteEndpointID=d.endpoint.getRemoteEndpointID())}),c.$on("session:alerting",function(a,d){b.debug("session:alerting received: endpointID = "+d.endpoint.id),c.epCtrlActiveEndpointUUID!=d.endpoint.id&&(c.sessionState="session:alerting",c.epCtrlRemoteEndpointID=d.endpoint.getRemoteEndpointID())}),c.$on("session:connecting",function(a,d){b.debug("session:connecting received: endpointID = "+d.endpoint.id),c.sessionState="session:connecting",c.epCtrlRemoteEndpointID=d.endpoint.getRemoteEndpointID()}),c.$on("session:queued",function(a,d){b.debug("session:queued received: endpointID = "+d.endpoint.id),c.epCtrlActiveEndpointUUID==d.endpoint.id&&(c.sessionState="session:queued",c.epCtrlRemoteEndpointID=d.endpoint.getRemoteEndpointID())}),c.$on("session:trying",function(a,d){b.debug("session:trying received: endpointID = "+d.endpoint.id),c.epCtrlActiveEndpointUUID==d.endpoint.id&&(c.sessionState="session:trying",c.epCtrlRemoteEndpointID=d.endpoint.getRemoteEndpointID())}),c.$on("session:ringing",function(a,d){b.debug("session:ringing received: endpointID = "+d.endpoint.id),c.epCtrlActiveEndpointUUID==d.endpoint.id&&(c.sessionState="session:ringing",c.epCtrlRemoteEndpointID=d.endpoint.getRemoteEndpointID())}),c.$on("endpointActivated",function(b,d){c.epCtrlActiveEndpointUUID=d,c.epCtrlRemoteEndpointID=a.getEndpoint(d).getRemoteEndpointID(),c.sessionState=a.getSessionState(d)}),c.$on("noEndpointActivated",function(a){c.epCtrlRemoteEndpointID=null,c.sessionState="session:stopped"}),c.$on("rtcomm::init",function(b,d,e){d===!0&&(c.epCtrlActiveEndpointUUID=a.getActiveEndpoint(),c.epCtrlRemoteEndpointID=a.getRemoteEndpoint(c.epCtrlActiveEndpointUUID),c.sessionState=a.getSessionState(c.epCtrlActiveEndpointUUID),c.failureReason=""),0==d&&(c.sessionState="session:stopped",c.epCtrlRemoteEndpointID=null)})}]}}function f(a,b){return{restrict:"E",templateUrl:"templates/rtcomm/rtcomm-video.html",controller:"RtcommVideoController"}}function g(a,b){return{restrict:"E",templateUrl:"templates/rtcomm/rtcomm-chat.html",controller:["$scope",function(c){c.chatActiveEndpointUUID=a.getActiveEndpoint(),c.chats=a.getChats(c.chatActiveEndpointUUID),c.$on("endpointActivated",function(d,e){b.debug("rtcommChat: endpointActivated ="+e),c.chats=a.getChats(e),c.chatActiveEndpointUUID=e}),c.$on("noEndpointActivated",function(a){c.chats=[],c.chatActiveEndpointUUID=null}),c.keySendMessage=function(a){13===a.which&&c.sendMessage()},c.sendMessage=function(){var b={time:new Date,name:a.getEndpoint(c.chatActiveEndpointUUID).getLocalEndpointID(),message:angular.copy(c.message)};c.message="",c.scrollToBottom(!0),a.sendChatMessage(b,c.chatActiveEndpointUUID)}}],controllerAs:"chat",link:function(a,c){var d=angular.element(c.find(".panel-body")[0]),e=!0;a.scrollToBottom=function(a){e=a},d.length>0?(d.bind("scroll",function(){d.prop("scrollTop")+d.prop("clientHeight")==d.prop("scrollHeight")?a.scrollToBottom(!0):a.scrollToBottom(!1)}),a.$watch("chats",function(){e&&d.scrollTop(d.prop("scrollHeight"))},!0)):b.warn("chatPanel not found: most likely you need to load jquery prior to angular")}}}function h(a,b,c,d,e){return{restrict:"E",templateUrl:"templates/rtcomm/rtcomm-iframe.html",controller:["$scope",function(f){f.iframeActiveEndpointUUID=a.getActiveEndpoint(),f.iframeURL=null,f.initiframeURL=null,f.syncSource=!1,f.init=function(a){1==a&&(f.syncSource=!0,f.initiframeURL=d.absUrl())},f.$on("session:started",function(c,d){b.debug("session:started received: endpointID = "+d.endpoint.id),1==f.syncSource&&a.putIframeURL(d.endpoint.id,f.initiframeURL)}),f.$on("endpointActivated",function(d,e){b.debug("rtcommIframe: endpointActivated ="+e),0==f.syncSource&&(f.iframeURL=c.trustAsResourceUrl(a.getIframeURL(e)),f.iframeActiveEndpointUUID=e)}),f.$on("noEndpointActivated",function(a){0==f.syncSource&&(f.iframeURL=c.trustAsResourceUrl("about:blank"),f.iframeActiveEndpointUUID=null)}),f.$on("rtcomm::iframeUpdate",function(a,d,g){0==f.syncSource?(b.debug("rtcomm::iframeUpdate: "+g),g+="?disableRtcomm=true",f.iframeURL=c.trustAsResourceUrl(g)):(b.debug("rtcomm::iframeUpdate: load this url in a new tab: "+g),e.open(c.trustAsResourceUrl(g),"_blank"))}),f.setURL=function(d){b.debug("rtcommIframe: setURL: newURL: "+d),a.putIframeURL(f.iframeActiveEndpointUUID,d),f.iframeURL=c.trustAsResourceUrl(d)},f.forward=function(){},f.backward=function(){}}],controllerAs:"rtcommiframe"}}function i(a,b,c,d,e){b.alertingEndpointUUID=null,b.autoAnswerNewMedia=!1,b.alertActiveEndpointUUID=c.getActiveEndpoint(),b.caller=null,b.init=function(a){e.debug("rtcommAlert: autoAnswerNewMedia = "+a),b.autoAnswerNewMedia=a},b.$on("endpointActivated",function(a,c){b.alertActiveEndpointUUID=c}),b.$on("session:alerting",function(a,c){b.alertActiveEndpointUUID==c.endpoint.id&&0==b.autoAnswerNewMedia||b.alertActiveEndpointUUID!=c.endpoint.id?(e.debug("rtcommAlert: display alterting model: alertActiveEndpointUUID = "+c.endpoint+" autoAnswerNewMedia = "+b.autoAnswerNewMedia),b.caller=c.endpoint.getRemoteEndpointID(),b.alertingEndpointUUID=c.endpoint.id,b.showAlerting()):(e.debug("Accepting media from: "+c.endpoint.getRemoteEndpointID()+" for endpoint: "+c.endpoint.id),c.endpoint.accept())}),b.showAlerting=function(f){var g=d.open({templateUrl:"templates/rtcomm/rtcomm-modal-alert.html",controller:"RtcommAlertModalInstanceController",size:f,backdrop:"static",resolve:{caller:function(){return b.caller}}});g.result.then(function(){var d=c.getEndpoint(b.alertingEndpointUUID);d&&(e.debug("Accepting call from: "+b.caller+" for endpoint: "+b.alertingEndpointUUID),d.accept(),a.$broadcast("rtcomm::alert-success"),d=null)},function(){var a=c.getEndpoint(b.alertingEndpointUUID);a&&(e.debug("Rejecting call from: "+b.caller+" for endpoint: "+b.alertingEndpointUUID),a.reject(),a=null)})}}function j(a,b,c,d){a.caller=d,a.ok=function(){c.debug("Accepting alerting call"),b.close()},a.cancel=function(){c.debug("Rejecting alerting call"),b.dismiss("cancel")}}function k(a,b,c,d){a.calleeID=null,a.callerID=null,a.enableCallModel=!1,a.mediaToEnable=["chat"],a.init=function(b,c){a.calleeID=b,"undefined"!=typeof c&&(a.mediaToEnable=c)},a.$on("rtcomm::init",function(b,c,e){d.debug("RtcommCallModalController: rtcomm::init: success = "+c),1==c?a.enableCallModel=!0:a.enableCallModel=!1}),a.$on("session:started",function(b,c){a.enableCallModel=!1}),a.$on("session:stopped",function(b,c){a.enableCallModel=!0}),a.placeCall=function(e){var f=c.open({templateUrl:"templates/rtcomm/rtcomm-modal-call.html",controller:"RtcommCallModalInstanceController",size:e,resolve:{}});f.result.then(function(c){d.debug("rtcommCallModal: Calling calleeID: "+a.calleeID),d.debug("rtcommCallModal: CallerID: "+c),null==a.callerID&&"undefined"!=typeof c&&""!=c&&(a.callerID=c,b.setAlias(c)),b.placeCall(a.calleeID,a.mediaToEnable)},function(){d.info("Modal dismissed at: "+new Date)})}}function l(a,b,c){a.endpointAlias="",a.ok=function(){b.close(a.endpointAlias)},a.cancel=function(){b.dismiss("cancel")}}function m(a,b,c,d){a.extendedConfig=null,d.debug("RtcommConfigController: configURL = "+a.configURL),a.setConfig=function(a){d.debug("RtcommConfigController: setting config data:"+a),c.setConfig(a)},a.init=function(b,c){d.debug("RtcommConfigController: initing configURL = "+b),a.configURL=b,"undefined"!=typeof c&&(a.extendedConfig=c),a.getConfig()},a.getConfig=function(){b.get(a.configURL).success(function(b){null!=a.extendedConfig&&(angular.extend(b,a.extendedConfig),d.debug("RtcommConfigController: extended config object: "+b)),c.setConfig(b)}).error(function(a,b,c,e){d.debug("RtcommConfigController: error accessing config: "+b)})}}function n(a,b,c,d){a.avConnected=c.isWebrtcConnected(c.getActiveEndpoint()),a.init=function(a,b){c.setViewSelector(a,b);var d=c.getActiveEndpoint();"undefined"!=typeof d&&null!=d&&c.setVideoView(d)};var e=c.getActiveEndpoint();"undefined"!=typeof e&&null!=e&&c.setVideoView(e),a.$on("endpointActivated",function(b,e){d.debug("rtcommVideo: endpointActivated ="+e),c.setVideoView(e),a.avConnected=c.isWebrtcConnected(c.getActiveEndpoint())}),a.$on("noEndpointActivated",function(b){a.avConnected=!1}),a.$on("webrtc:connected",function(b,d){c.getActiveEndpoint()==d.endpoint.id&&(a.avConnected=!0)}),a.$on("webrtc:disconnected",function(b,d){c.getActiveEndpoint()==d.endpoint.id&&(a.avConnected=!1)})}function o(a,b,c,d,e){a.epCtrlActiveEndpointUUID=d.getActiveEndpoint(),a.epCtrlAVConnected=d.isWebrtcConnected(a.epCtrlActiveEndpointUUID),a.sessionState=d.getSessionState(a.epCtrlActiveEndpointUUID),a.disconnect=function(){e.debug("Disconnecting call for endpoint: "+a.epCtrlActiveEndpointUUID),d.getEndpoint(a.epCtrlActiveEndpointUUID).disconnect()},a.toggleAV=function(){e.debug("Enable AV for endpoint: "+a.epCtrlActiveEndpointUUID),0==a.epCtrlAVConnected?d.getEndpoint(a.epCtrlActiveEndpointUUID).webrtc.enable(function(a,b){a||(e.debug("Enable failed: ",b),d.alert({type:"danger",msg:b}))}):(e.debug("Disable AV for endpoint: "+a.epCtrlActiveEndpointUUID),d.getEndpoint(a.epCtrlActiveEndpointUUID).webrtc.disable())},a.$on("session:started",function(b,c){e.debug("session:started received: endpointID = "+c.endpoint.id),a.epCtrlActiveEndpointUUID==c.endpoint.id&&(a.sessionState="session:started")}),a.$on("session:stopped",function(b,c){e.debug("session:stopped received: endpointID = "+c.endpoint.id),a.epCtrlActiveEndpointUUID==c.endpoint.id&&(a.sessionState="session:stopped")}),a.$on("session:failed",function(b,c){e.debug("session:failed received: endpointID = "+c.endpoint.id),a.epCtrlActiveEndpointUUID==c.endpoint.id&&(a.sessionState="session:failed")}),a.$on("webrtc:connected",function(b,c){a.epCtrlActiveEndpointUUID==c.endpoint.id&&(a.epCtrlAVConnected=!0)}),a.$on("webrtc:disconnected",function(b,c){a.epCtrlActiveEndpointUUID==c.endpoint.id&&(a.epCtrlAVConnected=!1)}),a.$on("endpointActivated",function(b,c){a.epCtrlActiveEndpointUUID=c,a.epCtrlAVConnected=d.isWebrtcConnected(c)}),a.$on("noEndpointActivated",function(b){a.epCtrlAVConnected=!1})}angular.module("angular-rtcomm-ui",["ui.bootstrap","angular-rtcomm-service"]).directive("rtcommSessionManager",a).directive("rtcommRegister",b).directive("rtcommQueues",c).directive("rtcommAlert",d).directive("rtcommEndpointStatus",e).directive("rtcommVideo",f).directive("rtcommChat",g).directive("rtcommIframe",h).controller("RtcommAlertModalController",i).controller("RtcommAlertModalInstanceController",j).controller("RtcommCallModalController",k).controller("RtcommCallModalInstanceController",l).controller("RtcommConfigController",m).controller("RtcommVideoController",n).controller("RtcommEndpointController",o),a.$inject=["RtcommService","$log"],b.$inject=["RtcommService","$log"],c.$inject=["RtcommService","$log"],d.$inject=["$log"],e.$inject=["RtcommService","$log"],f.$inject=["RtcommService","$log"],g.$inject=["RtcommService","$log"],h.$inject=["RtcommService","$log","$sce","$location","$window"],i.$inject=["$rootScope","$scope","RtcommService","$modal","$log"],j.$inject=["$scope","$modalInstance","$log","caller"],k.$inject=["$scope","RtcommService","$modal","$log"],l.$inject=["$scope","$modalInstance","RtcommService"],m.$inject=["$scope","$http","RtcommService","$log"],n.$inject=["$scope","$http","RtcommService","$log"],o.$inject=["$scope","$rootScope","$http","RtcommService","$log"]}(),function(){function a(a,b){return{restrict:"E",templateUrl:"templates/rtcomm/rtcomm-presence.html",controller:["$scope","$rootScope",function(c,d){c.monitorTopics=[],c.presenceData=[],c.expandedNodes=[],c.protocolList={chat:!0,webrtc:!1},c.flatten=!1,c.treeOptions={nodeChildren:"nodes",dirSelectable:!0,injectClasses:{ul:"a1",li:"a2",liSelected:"a7",iExpanded:"a3",iCollapsed:"a4",iLeaf:"a5",label:"a6",labelSelected:"a8"}},c.init=function(a){c.protocolList.chat="boolean"==typeof a.chat?a.chat:c.protocolList.chat,c.protocolList.webrtc="boolean"==typeof a.webrtc?a.webrtc:c.protocolList.webrtc,c.flatten="boolean"==typeof a.flatten?a.flatten:c.flatten},c.onCallClick=function(b){var e=a.getEndpoint();a.setActiveEndpoint(e.id),1==c.protocolList.chat&&e.chat.enable(),1==c.protocolList.webrtc&&e.webrtc.enable(function(b,c){b||a.alert({type:"danger",msg:c})}),e.connect(b),d.$broadcast("rtcomm::presence-click")},c.$on("rtcomm::init",function(d,e,f){a.publishPresence();var g=a.getPresenceMonitor();g.on("updated",function(a){b.debug("<<------rtcommPresence: updated------>>"),c.flatten&&(b.debug("<<------rtcommPresence: updated using flattened data ------>>"),c.presenceData=a[0].flatten()),c.$apply()}),c.flatten||(c.presenceData=g.getPresenceData()),c.presenceData.length>=1&&c.expandedNodes.push(c.presenceData[0]);for(var h=0;h<c.monitorTopics.length;h++)b.debug("rtcommPresence: monitorTopic: "+c.monitorTopics[h]),g.add(c.monitorTopics[h])})}],controllerAs:"presence"}}angular.module("angular-rtcomm-presence",["ui.bootstrap","treeControl","angular-rtcomm-service"]).directive("rtcommPresence",a),a.$inject=["RtcommService","$log"]}(),angular.module("angular-rtcomm-ui").run(["$templateCache",function(a){"use strict";a.put("templates/rtcomm/rtcomm-alert.html",'<div class="row"><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert></div>'),a.put("templates/rtcomm/rtcomm-chat.html",'<div><div class="panel panel-primary vertical-stretch"><div class="panel-heading"><span class="glyphicon glyphicon-comment"></span> Chat</div><div class="panel-body"><ul class="chat"><li class="right clearfix" ng-repeat="chat in chats"><div id="{{$index}}" class="header"><strong class="primary-font">{{chat.name}}</strong> <small class="pull-right text-muted">{{chat.time | date:\'HH:mm:ss\'}}</small></div><p>{{chat.message}}</p></li></ul></div><div class="panel-footer"><div class="input-group"><input id="chat-input" type="text" class="form-control input-sm" placeholder="Type your message here..." type="text" ng-model="message" ng-keypress="keySendMessage($event)"> <span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btn-chat" ng-click="sendMessage()" focusinput="true" ng-disabled="(chatActiveEndpointUUID == null)">Send</button></span></div></div></div></div><!-- chat list ng-controller div -->'),a.put("templates/rtcomm/rtcomm-endpoint-status.html",'<div class="endpoint-status"><p class="endpoint-controls-title navbar-text pull-right" ng-switch on="sessionState"><span ng-switch-when="session:started">Connected to {{epCtrlRemoteEndpointID}}</span> <span ng-switch-when="session:stopped">No active sessions, waiting...</span> <span ng-switch-when="session:alerting">Inbound call from {{epCtrlRemoteEndpointID}}</span> <span ng-switch-when="session:trying">Attempting to call {{epCtrlRemoteEndpointID}}</span> <span ng-switch-when="session:ringing">Call to {{epCtrlRemoteEndpointID}} is ringing</span> <span ng-switch-when="session:queued">Waiting in queue at: {{queueCount}}</span> <span ng-switch-when="session:failed">Call failed with reason: {{failureReason}}</span> <span ng-switch-when="session:connecting">Connecting to {{epCtrlRemoteEndpointID}} ...</span></p></div>'),
a.put("templates/rtcomm/rtcomm-iframe.html",'<div><div class="panel panel-primary vertical-stretch"><div class="panel-heading"><span class="glyphicon glyphicon-link"></span> URL Sharing</div><div class="rtcomm-iframe"><iframe width="100%" height="100%" ng-src="{{iframeURL}}"></iframe></div><div class="row"><div class="col-lg-2"><button id="btnBackward" class="btn btn-primary" ng-click="backward()" focusinput="true" ng-disabled="(iframeUrl == null)"><span class="glyphicon glyphicon-arrow-left" aria-hidden="true" aria-label="Backward"></span> Backward</button></div><div class="col-lg-2"><button id="btnForward" class="btn btn-primary" ng-click="forward()" ng-disabled="(iframeUrl == null)"><span class="glyphicon glyphicon-arrow-right" aria-hidden="true" aria-label="Forward"></span> Forward</button></div><div class="col-lg-8"><div class="input-group"><input id="setUrl" type="text" class="form-control" type="text" ng-model="newUrl"><span class="input-group-btn"><button class="btn btn-primary" id="btn-send-url" ng-click="setURL(newUrl)" focusinput="true">Set URL</button></span></div><!-- /input-group --></div></div></div></div>'),a.put("templates/rtcomm/rtcomm-modal-alert.html",'<div class="modal-header"><button type="button" class="close" ng-click="close(false)" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">New call alert</h4></div><div class="modal-body"><p>Do you want to accept a call from {{caller}}.</p></div><div class="modal-footer"><button type="button" ng-click="ok()" class="btn btn-default" data-dismiss="modal">Yes</button> <button type="button" ng-click="cancel()" class="btn btn-primary" data-dismiss="modal">No</button></div>'),a.put("templates/rtcomm/rtcomm-modal-call.html",'<div class="modal-header"><button type="button" class="close" ng-click="close(false)" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">Get Help</h4></div><div class="modal-body"><p>To help us serve you better, please provide some information before we begin.</p><form class="form-horizontal" role="form"><div class="form-group"><label for="name" class="col-sm-2 control-label">Name</label><div class="col-sm-10"><input type="text" class="form-control" id="name" placeholder="Your Name" ng-model="endpointAlias"></div></div></form></div><div class="modal-footer"><button type="button" ng-click="ok()" class="btn btn-default" data-dismiss="modal">Connect</button> <button type="button" ng-click="cancel()" class="btn btn-default" data-dismiss="modal">Cancel</button></div>'),a.put("templates/rtcomm/rtcomm-queues.html",'<div><div class="panel panel-primary"><div class="panel-heading"><span class="glyphicon glyphicon-sort-by-attributes-alt"></span> Queues</div><div class="queueContainer"><button type="button" ng-class="{\'btn btn-primary btn-default btn-block\': queue.active, \'btn btn-default btn-default btn-block\': !queue.active}" ng-repeat="queue in rQueues" ng-click="onQueueClick(queue)" data-toggle="tooltip" data-placement="top" title="{{queue.description}}">{{queue.active ? \'Leave\' : \'Join\'}} {{queue.endpointID}}</button></div></div></div>'),a.put("templates/rtcomm/rtcomm-register.html",'<div><div class="panel panel-primary"><div class="input-group"><input id="register-input" type="text" class="form-control input-sm" placeholder="Enter your ID here..." type="text" ng-model="reguserid" ng-disabled="(nextAction==\'Unregister\')"><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btn-register" ng-click="onRegClick(reguserid)" ng-disabled="invalid" focusinput="true">{{nextAction}}</button></span></div></div></div>'),a.put("templates/rtcomm/rtcomm-sessionmgr.html",'<div class="session-manager"><div class="btn-group pull-left" style="padding: 10px"><div><button class="session-manager-button" type="button" ng-switch on="session.activated" ng-class="{\'btn btn-primary btn-sm\': session.activated, \'btn btn-default btn-sm\': !session.activated}" ng-repeat="session in sessions" ng-click="activateSession(session.endpointUUID)"><span class="glyphicon glyphicon-eye-open" aria-hidden="true" ng-switch-when="true"></span> <span class="glyphicon glyphicon-eye-close" aria-hidden="true" ng-switch-when="false"></span> {{session.remoteEndpointID}}</button></div></div><p class="session-manager-title navbar-text pull-right">Sessions</p></div>'),a.put("templates/rtcomm/rtcomm-video.html",'<div id="videoContainer"><div id="selfViewContainer"><video title="selfView" id="selfView" class="selfView" autoplay muted></video></div><video title="remoteView" id="remoteView" class="remoteView" autoplay></video><!--  video title="remoteView" id="remoteView" class="remoteView" autoplay="true" poster="../views/rtcomm/images/video_camera_big.png"></video --></div>')}]),angular.module("angular-rtcomm-presence").run(["$templateCache",function(a){"use strict";a.put("templates/rtcomm/rtcomm-presence.html",'<div treecontrol class="tree-light" tree-model="presenceData" options="treeOptions" on-selection="showSelected(node)" expanded-nodes="expandedNodes"><button type="button" class="btn btn-primary btn-xs" aria-label="Left Align" ng-show="(node.record && !node.self)" ng-click="onCallClick(node.name)"><span class="glyphicon glyphicon-facetime-video" aria-hidden="true" aria-label="expand record"></span></button> {{node.name}} {{node.value ? \': \' + node.value : \'\'}}</div>')}]);